{% extends "login/base-list.html" %}
{% load extra_filters %}
{% load staticfiles %}

{% block css %}
{{ block.super }}
<style type="text/css">
    table td {
        padding: 2px;
    }
    table th {
        padding: 2px;
    }
    .filter-section {
        margin-bottom: 20px;
        background-color: #f5f5f5;
        padding: 15px;
        border-radius: 5px;
    }
</style>
{% endblock %}

{% block section_title %}Reporte de Status de Entrega Pedidos{% endblock %}

{% block content %}
<div class="col-md-12">
    <div class="panel panel-inverse">
        <div class="panel-heading">
            <div class="panel-heading-btn">
                <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-default" data-click="panel-expand"><i class="fa fa-expand"></i></a>
                <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-warning" data-click="panel-collapse"><i class="fa fa-minus"></i></a>
            </div>
            <h4 class="panel-title">Filtros de Búsqueda</h4>
        </div>
        
        <div class="panel-body">
                <div class="row filter-section">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Cliente</label>
                            <select name="cliente" id="cliente-select" class="form-control">
                                <option value="">Todos los Clientes</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id_cliente }}" {% if cliente.idcliente == cliente_seleccionado %}selected{% endif %}>
                                    {{ cliente.nombre_cliente }}
                                </option>
                                {% endfor %}
                            </select>                                                                                   
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>No. Pedido</label>
                            <select name="pedido" id="pedido-select" class="form-control" {% if not pedidos %}disabled{% endif %}>
                                <option value="">Seleccione un Pedido</option>
                                {% for pedido in pedidos %}
                                <option value="{{ pedido.id }}" {% if pedido.id == pedido_seleccionado %}selected{% endif %}>
                                    {{ pedido.id }} - {{ pedido.cliente.nombre }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <br>
                    <a class="default btn btn-link"  onclick="consultar()"> <button type="button" class="btn btn-primary btn-lg">  Consultar </button> </a>
            </div>
    </div>

    <div class="panel panel-inverse">
        <div class="panel-heading">
            <h4 class="panel-title">Reporte de Status de Entrega</h4>
        </div>
        
        <div class="panel-body">
            <h4>REPORTE STATUS DE ENTREGA PEDIDOS</h4>
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Pedido</th>
                            <th>% Cumplimiento Fecha</th>
                            <th>% Cumplimiento OPs</th>
                            <th>Cliente</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if status_pedidos %}
                            {% for pedido in status_pedidos %}
                                <tr>
                                    <td>{{ pedido.id }}</td>
                                    <td>"De donde salen"</td>
                                    <td>"De donde salen"</td>
                                    <td>{{ pedido.cliente }}</td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="4" style="text-align: center;">No data</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <h4>REPORTE DE GUIAS</h4>
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Fecha Emisión</th>
                            <th># Transferencia</th>
                            <th>Items / OP</th>
                            <th>Pedido</th>
                            <th>Cliente</th>
                            <th>Fecha de Compromiso</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if guias %}
                            {% for guia in guias %}
                                <tr>
                                    <td>{{ guia.fecha_emision }}</td>
                                    <td>{{ guia.nro_guia }}</td>
                                    <td>{{ guia.items_op }}</td>
                                    <td>{{ guia.pedido }}</td>
                                    <td>{{ guia.cliente }}</td>
                                    <td>{{ guia.fecha_compromiso|date:"d/m/Y" }}</td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" style="text-align: center;">No data</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script type="text/javascript">
    $(document).ready(function() {

        // Lógica para cargar pedidos según el cliente seleccionado
        $('#cliente-select').change(function() {
            let clienteId = $(this).val();
            // Limpiar y deshabilitar select de pedidos
            $('#pedido-select').html('<option value="">Seleccione un Pedido</option>').prop('disabled', true);
            
            if (clienteId) {
                // Llamada AJAX para obtener pedidos del cliente
                $.ajax({
                    url: '/reporte/obtener_pedidos_cliente/',
                    type: 'POST',
                    data: {
                        'cliente_id': clienteId,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    dataType: 'json',
                    success: function(data) {
                        // Poblar select de pedidos
                        var pedidoSelect = $('#pedido-select');
                        pedidoSelect.prop('disabled', false);
                        pedidoSelect.innerHtml = '';
                        
                        $.each(data, function(index, pedido) {
                            pedidoSelect.append(
                                $('<option></option>')
                                    .val(pedido.id)
                                    .text(pedido.id + ' - ' + pedido.codigo)
                            );
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('Error al obtener los pedidos:', error);
                    }
                });
            }
        });

        debugger;
        let clienteId = $('#cliente-select').val();
        if (clienteId) {
            // Llamada AJAX para obtener pedidos del cliente
            $.ajax({
                url: '/reporte/obtener_pedidos_cliente/',
                type: 'POST',
                data: {
                    'cliente_id': clienteId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                dataType: 'json',
                success: function(data) {
                    // Poblar select de pedidos
                    var pedidoSelect = $('#pedido-select');
                    pedidoSelect.prop('disabled', false);
                    pedidoSelect.innerHtml = '';
                    
                    if (Array.isArray(data)) {
                        $.each(data, function(index, pedido) {
                            pedidoSelect.append(
                                $('<option></option>')
                                    .val(pedido.id)
                                    .text(pedido.id + ' - ' + pedido.codigo)
                            );
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error al obtener los pedidos:', error);
                }
            });
        }
    });

    function consultar() {
        alert('Consultar');
        var clienteId = $('#cliente-select').val();
        var pedidoId = $('#pedido-select').val();

        $.ajax({
            url: '/reporte/obtener_reporte_status_entregas/',
            type: 'POST',
            data: {
                'cliente_id': clienteId,
                'pedido_id': pedidoId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(data) {
                console.log('Data:', data);
            },
            error: function(xhr, status, error) {
                console.error('Error al obtener el reporte:', error);
            }
        });
    }
</script>
{% endblock %}