{% extends "login/base-list.html" %}
{% load extra_filters %}

{% load staticfiles %}

{% block css %}
{{ block.super }}
{% endblock %}

{% block section_title %}Pedido{% endblock %}
{% block section_subtitle %}
<br />
 <div class="email-btn-row hidden-xs">
                        <a href="{% url 'pedido-create' %}" class="btn btn-sm btn-success"><i class="fa fa-plus m-r-5"></i> Nuevo Pedido</a>
                    </div>

                    {% endblock %}

{% block content %}
				<!-- begin col-12 -->
				<div class="col-md-12">
					<!-- begin panel -->
					<div class="panel panel-inverse">
						<div class="panel-heading">
							<div class="panel-heading-btn">
								<a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-default" data-click="panel-expand"><i class="fa fa-expand"></i></a>
								<a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-warning" data-click="panel-collapse"><i class="fa fa-minus"></i></a>
							</div>
							<h4 class="panel-title"></h4>
						</div>
						<div class="panel-body">
							<div class="table-responsive">
								<table id="data-pedido" class="table table-striped table-bordered">
									<thead>
										<tr>
											<th>Codigo</th>
											<th>Fecha</th>
											<th>Cliente</th>
											<th>Subtotal</th>
											<th>Descuento</th>
											<th>Valor Descuento</th>
											<th>Iva</th>
											<th>Saldo Actual</th>
											<th>Total </th>
											<th>Cod. Proforma</th>
											<th>Estado </th>

											<th>Acción </th>
										</tr>
									</thead>
				<!--					<tbody>
										{% for r  in pedidos %}
									
											<tr>
												<td> {{ r.codigo }}</a></td>
												<td>{{ r.fecha }}</td>
												<td>{{ r.cliente.nombre_cliente }}</td>
												<td>{{ r.subtotal}}</td>
												<td>{{ r.porcentaje_descuento }}</td>
												<td>{{ r.descuento}}</td>
												<td>{{ r.iva}}</td>
												<td>{{ r.total}}</td>
											<td>{{ r.abreviatura_codigo}}-{{ r.proforma_codigo}}</td>
														<td>{% if r.aprobada %}
												Aprobada
												{% elif r.anulada %}
														Anulada 
														{% else %}
														Esperando aprobacion

														{% endif %}


															{% if r.finalizar_maqueteado  %}
															          *Finalizado render
															{% else %}

															{% endif %}
												</td>
																							
												<td>
											{% if r.aprobada %}
												
											{% elif r.anulada %}
														 
											{% else %}
<a href="{% url 'pedido-update' r.id %}">
						<button type="button" class="btn btn-info btn-xs"><i class="fa fa-cog"></i> Editar</button>				</a>														{% endif %}
											{% if r.finalizar_maqueteado %}
						  <span class="input-group-btn input">
                                                <a href="javascript: render_ad('{{r.id}}')" class="btn btn-xs btn-default" data-toggle="modal">
													<i class="fa fa-camera">
													Ver Render
												</i></a></span>
													{% endif %}
                                                    <a href="{% url 'pedido-imprimir' r.id %}">
														<button type="button" class="btn btn-info btn-xs"><i class="fa fa-cog"></i> Imprimir</button>								
													</a>	
                                                    <a href="{% url 'pedido-imprimir-valores' r.id %}">
														<button type="button" class="btn btn-info btn-xs"><i class="fa fa-cog"></i> Imprimir Valores</button>								
													</a>
												</td>
											</tr >
											
										{% endfor %} 
									</tbody>-->
								</table>
							</div>
</div>

						
						</div>
					</div>
					<!-- end panel -->

					<!-- #modal-dialog -->
			
				</div>
	<div aria-hidden="true" style="display: none;"  id="dlgRender" class="modal fade">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <button type="button" class="close" data-dismiss="modal">×</button>
                    <h4 id="id_popup_render" class="modal-title"></h4>
                </div>
                <div class="modal-body">
                   <div id="contenido_dlgRender">
                       <div class="indicator show"><span class="spinner spinner16"></span></div>
                   </div>
                </div>
            </div>
        </div>
    </div>

<!-- Modal Structure -->
<div class="modal fade" id="quantityModal" tabindex="-1" role="dialog" aria-labelledby="quantityModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quantityModalLabel">Entrar Saldo a Rebajar del Total</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="margin-top: -20px;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="quantityForm">
                    <div class="form-group">
                        <label for="quantityInput">Saldo:</label>
                        <input type="number" class="form-control" id="quantityInput" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="acceptButton">Aceptar</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>


				<!-- end col-12 -->	
{% endblock %}

{% block javascript %}
{{ block.super }}

	<script type="text/javascript">
		
		$(document).ready(function () {
            $('#data-pedido').DataTable({
                 "processing": true,
                 "serverSide": true,
                 "ajax": "/pedido/pedido/api",
                 "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
				 "order": [[ 0, "desc" ]],
                 dom: 'Blfrtip',
	buttons: [
	    'csv', 'excel', 'pdf'
	]
                  
            });
        });
		
	  function render_ad(prefix){
            $("#id_popup_ingresos").html("<b>Render de Pedido</b>");




            var parametros = {
                'id': prefix,
                'csrfmiddlewaretoken': '{{ csrf_token }}'

            }

            $.ajax({
                    url: "/pedido/ver/"+prefix+"/imagenRender",
                    type: "POST",
                    async: true,
                    data: parametros,
                    success: function(data){
                        $('#contenido_dlgRender').html(data);



                    },
                    complete: function(){
                       $("#btn_guardar_render").show();
                    }
                });
            $('#dlgRender').modal();
        }



	function detalledeCompra(id){
          $.ajax({
                url: "/config/obtenerDetalleCompra/", // the endpoint
                type : "POST", // http method
                data : { id : id,'csrfmiddlewaretoken': '{{ csrf_token }}'}, 
                success:function(data){
                	
                  $("#detalle tr").remove();

                  $("#detalle").append(data);
                },
                error: function(){
                 
                },
              });
    }
	</script>
	{% if form.errors or form_mode == "update" %}
	<script type="text/javascript">
		$( document ).ready(function() {
		    $(".modal").modal('toggle');
		});
	</script>
	{% endif %}

	<script type="text/javascript">
		$('#acceptButton').on('click', function() {
			const quantity = $('#quantityInput').val(); // Obtener la cantidad entrada en el input
			const productId = $(this).data('product-id'); // Get the product ID from the button
			if (quantity == "" || quantity.trim() == "") {
				alert("Debe entrar una cantidad");
				return;
			}

			// Here you can handle the logic to subtract the quantity from the total
			console.log(`Product ID: ${productId}, Quantity: ${quantity}`);

			$.ajax({
                url: "/pedido/pedido/" + productId + "/actualizarsaldo", // the endpoint
                type : "POST", // http method
                data : { cantidad : quantity},
                success:function(data){

                  $("#detalle tr").remove();

                  $("#detalle").append(data);
                },
                error: function(){

                },
              });

			// Cerrar el modal
			$('#quantityModal').modal('hide');
		});

		 $('#quantityModal').on('show.bs.modal', function (event) {
			var button = $(event.relatedTarget); // Botón que abrió el modal
			var productId = button.data('productId'); // Extraer información del atributo data-row
			$('#acceptButton').data('product-id', productId);
		});
    </script>
{% endblock %}





