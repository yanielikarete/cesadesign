{% extends "login/base-list.html" %}
{% load extra_filters %}

{% load staticfiles %}

{% block css %}
{{ block.super }}
<!-- ================== BEGIN PAGE LEVEL STYLE TABLE================== -->
    <style type="text/css">
    input[type="text"] {
    	width:100px !important;
    	}
    input[type="number"] {
    	width:100px !important;
    	}
    </style>
    <!-- ================== END PAGE LEVEL STYLE ================== -->
{% endblock %}

{% block section_title %}Producto{% endblock %}
{% block section_subtitle %}
<br />
 <div class="email-btn-row hidden-xs">

                    </div>

                    {% endblock %}

{% block content %}
				<!-- begin col-12 -->
		<form method="post" data-parsley-validate="true" name="form-wizard" enctype="multipart/form-data"> {% csrf_token %}

				<div class="col-md-12">
					<!-- begin panel -->
					<div class="panel panel-inverse">
						<div class="panel-heading">
							<div class="panel-heading-btn">
								<a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-default" data-click="panel-expand"><i class="fa fa-expand"></i></a>
								<a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-warning" data-click="panel-collapse"><i class="fa fa-minus"></i></a>
							</div>
							<h4 class="panel-title"> <table>
            <tr><td><b>&nbsp;{{ prod.codigo_producto }} {{ prod.descripcion_producto }}</b></td></tr>

            </table></h4>
						</div>


                                               <div class="panel panel-default panel-border">
                                                <div class="panel-heading">Nueva Area</div>
                                                <div class="panel-body">
                                                 <ul class="nav nav-tabs" role="tablist">
                                  <li role="presentation" class="active"><a href="#principales" aria-controls="principales" role="tab" data-toggle="tab">Principales</a></li>
                                   <li role="presentation"><a href="#foto" aria-controls="foto" role="tab" data-toggle="tab">Foto</a></li>
                                </ul>
			<div class="tab-content">
			<div role="tabpanel" class="tab-pane fade in active" id="principales">
                                                    <div class="col-md-4">
                                                     <label for="exampleInputName2">Area</label>

                                                    		<select name="ambientes" id="ambientes"  class="form-control">
							                                                         {% for am  in ambientes %}
							                                                           <option value="{{ am.id }}"> {{ am.descripcion }}</option>
							                                                        {% endfor %}
							                                                     </select>
						     </div>
                                                    <div class="col-md-4">
                                                            <label for="exampleInputName2">Secuencia</label>

							                                 <input type="number" class="form-control" id="secuencia" name="secuencia" >
							</div>
						     <div class="col-md-4">
                            <div class="row">
                                <div class="col-xs-12">
                                  <a href="#" class="thumbnail">
				    {% if prod.imagen %}
				  <img src="/media/{{ prod.imagen }}" alt="logo producto">

					{% else %}
                                    <img src="/media/imagenes/producto/logo-producto.svg" alt="logo producto">
					{% endif %}
                                  </a>
                                </div>
                            </div>

                        </div>
			 <div class="col-md-1" style="position:relative;margin-top:-80px">
							                                 <a class="btn btn-danger remove_fields" onclick="agregar({{ id }})">
							                                                        <i class="glyphicon glyphicon-plus icon-white"></i>
						     Agregar  Area      </a></div>
                         <div class="col-md-1" style="position:relative;margin-top:-80px;margin-left:120px">
                                                                    <a class="btn btn-danger remove_fields" onclick="mostrarProductos({{ id }})" style="margin-left:20px">
                                                                      <i class="glyphicon glyphicon-plus icon-white"></i>
                                                         Copiar Receta    </a>
													</div>


                                            <br />
<br />
<br />
<br />
<br />
<br />
<br />


						<div class="panel-body">
							<div class="table-responsive">


								<table id="data-table" class="table table-striped table-bordered">
									<thead>
										<tr>
										<th></th>
											<th>Areas</th>
											<th>Secuencia</th>
											<th>Horas</th>
											<th>Costo Horas</th>
											<th>Costo Materiales</th>
											<th>Accion</th>
										</tr>
									</thead>
									<tbody>
										{% for orden  in subordenes %}
											<tr>
												<td>
												<input type="hidden" id="id{{ forloop.counter }}" name="id{{ forloop.counter }}" value="{{ orden.id }}"><a class="btn btn-danger remove_fields" onclick="eliminar({{ orden.id }},{{ id }})">
                                                        <i class=" glyphicon glyphicon-trash icon-white"></i>
                                                      </a></td>
												<td><select name="id_areas{{ forloop.counter }}" id="id_areas{{ forloop.counter }}"  class="form-control">
                                                         {% for am  in ambientes %}
                                                           <option value="{{ am.id }}"
                                                           {% if orden.areas_id == am.id %}
                                                           selected="selected"
                                                           {% endif %}
                                                           > {{ am.descripcion }}</option>
                                                        {% endfor %}
                                                     </select>
                                                     </td>
												<td><input type="number" class="form-control" value="{{ orden.secuencia }}" id="secuencia_guardar{{ forloop.counter }}" name="secuencia_guardar{{ forloop.counter }}"/></td>
												<td>{{ orden.horas }}<input type="hidden" id="horas{{ forloop.counter }}" name="horas{{ forloop.counter }}" value="{{ orden.horas }}"></td>
												<td>{{ orden.costo_horas }}<input type="hidden" id="costo_horas{{ forloop.counter }}" name="costo_horas{{ forloop.counter }}" value="{{ orden.costo_horas }}"></td>

												<td>{{ orden.costo_materiales}}<input type="hidden" id="costo_material{{ forloop.counter }}" name="costo_material{{ forloop.counter }}" value="{{ orden.costo_materiales }}"></td>

												<td>

												<a href="{% url 'producto-receta' orden.id %}">
												<button type="button" class="btn btn-info btn-xs"><i class="fa fa-cog"></i> Materiales</button>	</a>
                        <a href="{% url 'producto-mano-obra' orden.id %}">
                        <button type="button" class="btn btn-info btn-xs"><i class="fa fa-cog"></i> Mano Obra</button> </a>
											</td>

											</tr >
										{% endfor %}

									</tbody>
                    <tfoot>
                    <tr>
                    <th></th>
                      <th></th>
                      <th>Total</th>
                      <th><input type="text" readonly="readonly" name="horas" id="horas"></th>
                      <th><input type="text" readonly="readonly" name="costo_horas" id="costo_horas"></th>
                      <th><input type="text" readonly="readonly" name="costo_material" id="costo_material"></th>
                      <th></th>
                    </tr>
                    </tfoot>
                    	</table>
							</div>
              <table class="table table-striped table-bordered">
                <tr><th>Costo Produccion:</th><td><input type="text" readonly="readonly" name="costo_produccion" id="costo_produccion"></td></tr>
                 <tr><th>Costo Fijo:</th><td><input type="text" readonly="readonly" name="costo_fijo" id="costo_fijo"></td></tr>
                <tr><th>Total:</th><td><input type="text" readonly="readonly" name="costo_total" id="costo_total"></td></tr>
              </table>
               <table class="table table-striped table-bordered">
                <tr><th>Precio 1:</th><td><input type="text"  name="porcentaje_precio1" id="porcentaje_precio1" onkeyup="actualizarTotal()" value="{{ prod.porcentaje_precio1}}">%</td><td><input type="text" readonly="readonly" name="precio1" id="precio1"></td></tr>
                <tr><th>Precio2:</th><td> <input type="text"  name="porcentaje_precio2" id="porcentaje_precio2" onkeyup="actualizarTotal()" value="{{ prod.porcentaje_precio2}}">%</td><td><input type="text" readonly="readonly" name="precio2" id="precio2"></td></tr>
                <tr><th>Precio3:</th><td> <input type="text" name="porcentaje_precio3" id="porcentaje_precio3" onkeyup="actualizarTotal()" value="{{ prod.porcentaje_precio3}}">%</td><td><input type="text" readonly="readonly" name="precio3" id="precio3"></td></tr>
              </table>



						</div>
					</div>

					{% if subordenes %}
<input type="hidden" name="columnas_receta" id="columnas_receta" value="{{ subordenes|length }}" />
{% else %}
<input type="hidden" name="columnas_receta" id="columnas_receta" value="1" />

{% endif %}
<input type="hidden" name="product" id="product" value="{{ id }}" />
<div role="tabpanel" class="tab-pane fade" id="foto">
                                        <div class="row">

                                            <div class="panel panel-default panel-border">
                                                <div class="panel-heading">Foto</div>
                                                <div class="panel-body">

                                                    <div class="col-md-4">
                                                      <label for="exampleInputName2">Imagen</label>
                                                    <input type="file" class="form-control" id="imagen" name="imagen">
                                                   </div>


                                                </div>
                                            </div>

                                        </div>
                                    </div>
<button type="submit" class="btn btn-primary btn-lg"><i class="fa fa-cog"></i> Guardar</button>
 </form>
  <div class="modal fade" id="modal-dialog">
                        <div class="modal-dialog">
                            <div class="modal-content">
                             <div class="panel-body">
                                <div class="table-responsive">
                                                    <table class="table table-striped table-bordered" id="tabla2">
                                                        <thead>
                                                            <tr>

                                                                <th>Codigo</th>
                                                                <th>Nombre</th>
                                                                <th></th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                        {% for producto  in productos %}
                                                            <tr>
                                                           <td>{{ producto.codigo_producto }}</td>
                                                                <td>{{ producto.descripcion_producto }}</td>
                                                                     <td  onclick="cargarCodigoProducto('{{ producto.producto_id }}','{{ producto.codigo_producto }}','{{ producto.descripcion_producto }}','{{ producto.medida_peso }}','{{ producto.costo }}')"><a class="btn btn-danger remove_fields">
                                                        <i class=" glyphicon glyphicon-plus icon-white"></i>Copiar
                                                      </a></td>
                                                            </tr >
                                                        {% endfor %}

                                                        </tbody>
                                                    </table>
                                                </div>
                                                <button type="button" onclick="cerrar()" class="btn btn-danger btn-block">Cerrar <i class=" glyphicon glyphicon-trash icon-white"></i></button>


                            </div>
                        </div>
                    </div>
                    </div>

				</div>
				</div>
				<!-- end col-12 -->

{% endblock %}

{% block javascript %}
{{ block.super }}

	<script type="text/javascript">
		 $(document).ready(function() {
    // App.init();
    $('#tabla2').DataTable();
    cambiarFormato();
    actualizarTotal();
             corregir();
  });
 function mostrarProductos(data){
       $('#id_fila_cambiar').val(data);
       $(".modal").modal('toggle');
    }
    function cerrar(){
       $(".modal").modal('toggle');
    }
 function actualizarTotal(){
      var num_recetas=$('#columnas_receta').val();
      var total=0;
      var horas=0;
      var costo_horas=0;
      var costo_material=0;
      var costo_produccion=0;
      var costo_fijo=0;
      var precio1=0;
      var precio2=0;

      var i;
      //alert(' BNUM RECETS'+num_recetas);
      for (i = 1; i <= num_recetas; i++) {

            horas=horas+parseFloat($('#horas'+i).val());
            costo_horas=costo_horas+parseFloat($('#costo_horas'+i).val());
            costo_material=costo_material+parseFloat($('#costo_material'+i).val());


      }
       porcentaje_descuento= $('#porcentaje_descuento').val();
       descuento=parseFloat(total*(porcentaje_descuento/100));
       total=total-descuento;
      // total=(total).toFixed(2);
      $('#horas').val((horas).toFixed(2));
      $('#costo_horas').val((costo_horas).toFixed(2));
      $('#costo_material').val((costo_material).toFixed(2));

costo_produccion=parseFloat(costo_horas)+parseFloat(costo_material);
            $('#costo_produccion').val((costo_produccion).toFixed(2));
            costo_fijo=parseFloat(costo_produccion)/2;
            $('#costo_fijo').val((costo_fijo).toFixed(2));
            total=costo_produccion+costo_fijo;
                        $('#costo_total').val((total).toFixed(2));
     var porcentaje1=$('#porcentaje_precio1').val();
     var porcentaje2=$('#porcentaje_precio2').val();
     var porcentaje3=$('#porcentaje_precio3').val();

     //Validaciond e porcentajes

           if (porcentaje1==null || porcentaje1==''  || porcentaje1=='None' ){

             // porcentaje1='0';
          }

           if (porcentaje2==null || porcentaje2==''  || porcentaje2=='None'){
              //porcentaje2='0';
              // alert("entro1");
          }

          if (porcentaje3==null || porcentaje3==''  || porcentaje3=='None'){
              //porcentaje3='0';
             // alert("entro3");

          }
          $('#porcentaje_precio1').val(porcentaje1);
     $('#porcentaje_precio2').val(porcentaje2);
     $('#porcentaje_precio3').val(porcentaje3);

            precio1=parseFloat(costo_produccion)+parseFloat(costo_fijo)+parseFloat(costo_produccion*porcentaje1/100);


            $('#precio1').val((precio1).toFixed(2));
   precio2=parseFloat(costo_produccion)+parseFloat(costo_fijo)+parseFloat(costo_produccion*porcentaje2/100);
            $('#precio2').val((precio2).toFixed(2));
      precio3=parseFloat(costo_produccion)+parseFloat(costo_fijo)+parseFloat(costo_produccion*porcentaje3/100);
            $('#precio3').val((precio3).toFixed(2));

    }
    function cargarCodigoProducto(id,codigo,descripcion,medida,costo){
       $.ajax({
                url: "/inventario/copiarReceta/", // the endpoint
                type : "POST", // http method
                data : { id : id,prod:{{ id }},'csrfmiddlewaretoken': '{{ csrf_token }}'},
                success:function(data){
                  window.location.href ="/inventario/producto_areas/"+{{ id }}+"/list";

                },
                error: function(){

                },
              });
          cerrar();

    }
	function detalledeCompra(id){
          $.ajax({
                url: "/config/obtenerDetalleCompra/", // the endpoint
                type : "POST", // http method
                data : { id : id,'csrfmiddlewaretoken': '{{ csrf_token }}'},
                success:function(data){
                  $("#detalle").append(data);
                },
                error: function(){

                },
              });
    }
      function agregar(id){
       var ambiente=$("#ambientes").val();
	   var secuencia=$("#secuencia").val();
          $.ajax({
                url: "/inventario/producto/agregarAmbiente/", // the endpoint
                type : "POST", // http method
                data : { id : id,secuencia : secuencia,ambiente : ambiente,'csrfmiddlewaretoken': '{{ csrf_token }}'},
                success:function(data){
                  alert("Se  agrego satisfactoriamente")
                  window.location.href ="/inventario/producto_areas/"+id+"/list";
                },
                error: function(){

                },
              });
    }
    function eliminar(id,pk){

          $.ajax({
                url: "/inventario/producto/eliminarProductoReceta/", // the endpoint
                type : "POST", // http method
                data : { id : id,'csrfmiddlewaretoken': '{{ csrf_token }}'},
                success:function(data){
                  alert("Se elimino el item satisfactoriamente");
                  window.location.href ="/inventario/producto_areas/"+pk+"/list";

                },
                error: function(){

                },
              });
    }

    function cambiarFormato(){
      var num_recetas=$('#columnas_receta').val();
      //alert(num_recetas);
      var total=0;
      var costo1=0;
      var subt=0;
      var porc_descu=0;
      var iva=0;
      var r_total=0;
      var r_subtotal=0;
      var total=0;
var porcentaje_iva=0;
      var i;
        var porcentaje1=0;
        var porcentaje2=0;
        var porcentaje3=0;
      //alert(' BNUM RECETS'+num_recetas);

      for (i = 1; i <= num_recetas; i++) {

        costo_horas= $('#costo_horas'+i).val();
          if (costo_horas){
          costo_horas = costo_horas.toString().replace(/\,/g,'.');
        $('#costo_horas'+i).val(costo_horas);
          }



        horas = $('#horas'+i).val();
           if (horas){
               horas = horas.toString().replace(/\,/g,'.');
        $('#horas'+i).val(horas);
           }


       costo_material = $('#costo_material'+i).val();
           if (costo_material) {
               costo_material = costo_material.toString().replace(/\,/g, '.');
               $('#costo_material' + i).val(costo_material);
           }

      }


       porcentaje1 = $('#porcentaje_precio1').val();
        if (porcentaje1) {
            porcentaje1 = porcentaje1.toString().replace(/\,/g, '.');
            $('#porcentaje_precio1').val(porcentaje1);
        }


       porcentaje2 = $('#porcentaje_precio2').val();
         if (porcentaje2) {
             porcentaje2 = porcentaje2.toString().replace(/\,/g, '.');
             $('#porcentaje_precio2').val(porcentaje2);
         }


       porcentaje3 = $('#porcentaje_precio3').val();
         if (porcentaje3) {
        porcentaje3 = porcentaje3.toString().replace(/\,/g,'.');
        $('#porcentaje_precio3').val(porcentaje3);
      }
    }


    function corregir(){
        var total=0;
      var costo1=0;
      var horas=0;
      var costo_horas=0;
      var costo_material=0;
      var costo_produccion=0;
      var costo_fijo=0;
      var total=0;
var porcentaje_iva=0;
      var i;
        var porcentaje1=0;
        var porcentaje2=0;
        var porcentaje3=0;
         var precio1=0;
        var precio2=0;
        var precio3=0;


         horas = $('#horas').val();
         if (horas=='NaN') {
              $('#horas').val('0');

         }
         costo_horas = $('#costo_horas').val();
         if (costo_horas=='NaN') {
              $('#costo_horas').val('0');

         }
         costo_material = $('#costo_material').val();
         if (costo_material=='NaN') {
              $('#costo_material').val('0');

         }

          costo_produccion = $('#costo_produccion').val();
         if (costo_produccion=='NaN') {
              $('#costo_produccion').val('0');

         }
         costo_fijo = $('#costo_fijo').val();
         if (costo_fijo=='NaN') {
              $('#costo_fijo').val('0');

         }

         total = $('#costo_total').val();
         if (total=='NaN') {
              $('#costo_total').val('0');

         }

        porcentaje1 = $('#porcentaje_precio1').val();
         if (porcentaje1=='None') {
              $('#porcentaje_precio1').val('0');

         }

         porcentaje2 = $('#porcentaje_precio2').val();
         if (porcentaje2=='None') {
              $('#porcentaje_precio2').val('0');

         }


          porcentaje3 = $('#porcentaje_precio3').val();
         if (porcentaje3=='None') {
              $('#porcentaje_precio3').val('0');

         }

         precio1 = $('#precio1').val();
         if (precio1=='NaN') {
              $('#precio1').val('0');

         }


          precio2 = $('#precio2').val();
         if (precio2=='NaN') {
              $('#precio2').val('0');

         }

          precio3 = $('#precio3').val();
         if (precio3=='NaN') {
              $('#precio3').val('0');

         }
    }



	</script>
	<!-- ================== END PAGE LEVEL JS ================== -->

{% endblock %}
