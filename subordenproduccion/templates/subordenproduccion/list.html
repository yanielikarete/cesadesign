{% extends "login/base-list.html" %}
{% load extra_filters %}

{% load staticfiles %}

{% block css %}
{{ block.super }}
{% endblock %}

{% block section_title %}SubOrdenes de Produccion{% endblock %}
{% block section_subtitle %}
<b>{{ op.tipo}} &nbsp;{{ op.codigo }}</b> <br />
							 <b>Fecha:</b>&nbsp; {{ op.fecha }} &nbsp;&nbsp;&nbsp;&nbsp;
							<b> Cliente:</b>&nbsp;{{ op.cliente.nombre_cliente }}<br />
							 <b>Descripci&oacute;n:</b>&nbsp;{{ op.descripcion }}<br />
							 <b>Detalle:</b>&nbsp;{{ op.detalle }}<br />
							 <b>Cantidad:</b>&nbsp;{{ op.cantidad }}<br />
 <div class="email-btn-row hidden-xs">

                    </div>

                    {% endblock %}

{% block content %}
				<!-- begin col-12 -->
		<form method="post" data-parsley-validate="true" name="form-wizard" enctype="multipart/form-data"> {% csrf_token %}

				<div class="col-md-12">
					<!-- begin panel -->
					<div class="panel panel-inverse">
						<div class="panel-heading">
							<div class="panel-heading-btn">
								<a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-default" data-click="panel-expand"><i class="fa fa-expand"></i></a>
								<a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-warning" data-click="panel-collapse"><i class="fa fa-minus"></i></a>
							</div>
							<h4 class="panel-title">

							 Sub Ordenes de Produccion</h4>
						</div>
						<div class="panel-body">
						<div class="col-md-4">
                                                     <label for="exampleInputName2">Area</label>
							<select name="ambientes" id="ambientes"  class="form-control">
                                                         {% for am  in ambientes %}
                                                           <option value="{{ am.id }}"> {{ am.descripcion }}</option>
                                                        {% endfor %}
                                                     </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                     <label for="exampleInputName2">Secuencia</label>
                                     <input type="number" class="form-control" id="secuencia" name="secuencia" >
 </div>
 <div class="col-md-4">
                                     <label for="exampleInputName2">Reproceso</label>
                                     <input type="checkbox" class="form-control" id="reproceso" name="reproceso" >
 </div>
                                                    <div class="col-md-4">
                                     <a class="btn btn-danger remove_fields" onclick="agregar({{ id }})">
                                                        <i class="glyphicon glyphicon-plus icon-white"></i>
                                                      </a>
						</div>
						<br /><br />						<br /><br />
						<br /><br />


							<div class="table-responsive">
								<table id="data-table" class="table table-striped table-bordered">
									<thead>
										<tr>
										<th></th>
											<th>Areas</th>
											<th>Secuencia</th>
											<th width="200px">Observaciones</th>
											<th>Finalizado</th>
											<th>Estado</th>


											<th>Accion</th>
										</tr>

									</thead>
									<tbody>
										{% for orden  in subordenes %}
                    {% if orden.reproceso %}
                     {% else %}
											<tr>
												<td>
												<input type="hidden" id="suborden_id{{ forloop.counter }}" name="suborden_id{{ forloop.counter }}" value="{{ orden.id }}"><a class="btn btn-danger remove_fields" onclick="eliminar({{ orden.id }},{{ id }})">
                                                        <i class=" glyphicon glyphicon-trash icon-white"></i>
                                                      </a></td>
												<td><select name="id_areas{{ forloop.counter }}" id="id_areas{{ forloop.counter }}"  class="form-control">
                                                         {% for am  in ambientes %}
                                                           <option value="{{ am.id }}"
                                                           {% if orden.areas_id == am.id %}
                                                           selected="selected"
                                                           {% endif %}
                                                           > {{ am.descripcion }}</option>
                                                        {% endfor %}
                                                     </select>
                                                     </td>
												<td><input type="number" class="form-control" value="{{ orden.secuencia }}" id="secuencia_guardar{{ forloop.counter }}" name="secuencia_guardar{{ forloop.counter }}"/></td>
												<td><textarea name="observaciones{{ forloop.counter }}"  id="observaciones{{ forloop.counter }}" cols="30" rows="5">
													{{ orden.observaciones }}
												</textarea></td>

												<td><input type="checkbox" class="form-control" name="finalizada{{ forloop.counter }}"  id="finalizada{{ forloop.counter }}"
												{% if orden.finalizada %}
                                                           checked="checked"
                                                           {% endif %}/></td>
<td>{% if orden.finalizada %}
												Finalizada

														{% else %}
												En Proceso
														{% endif %}
												</td>

												<td>

												<!-- <a href="{% url 'subordenproduccion-manoobra' orden.id %}">
												<button type="button" class="btn btn-info btn-xs"><i class="fa fa-cog"></i> Mano de Obra</button>	</a>
													<a href="{% url 'subordenproduccion-receta' orden.id %}">
												<button type="button" class="btn btn-info btn-xs"><i class="fa fa-cog"></i> Materiales</button>	</a> -->
												<a  onclick="enviarBodegaCrudo({{id}},{{orden.id}})" >
												<button type="button" class="btn btn-info btn-xs"><i class="fa fa-cog"></i> Enviar Bodega en Crudo</button>	</a>
                          <a href="{% url 'subordenproduccion-imprimir' orden.id %}" >
                        <button type="button" class="btn btn-info btn-xs"><i class="fa fa-cog"></i> Imprimir</button> </a>
											</td>

											</tr >
                       {% endif %}
										{% endfor %}

									</tbody>
								</table>
							</div>


<h4>REPROCESO</h4>

              <div class="table-responsive">
                <table id="data-table" class="table table-striped table-bordered">
                  <thead>
                    <tr>
                    <th></th>
                      <th>Areas</th>
                      <th>Secuencia</th>
                      <th width="200px">Observaciones</th>
                      <th>Finalizado</th>
                      <th>Estado</th>


                      <th>Accion</th>
                    </tr>

                  </thead>
                  <tbody>
                    {% for orden  in subordenes %}
                    {% if orden.reproceso %}

                      <tr>
                        <td>
                        <input type="hidden" id="suborden_id{{ forloop.counter }}" name="suborden_id{{ forloop.counter }}" value="{{ orden.id }}"><a class="btn btn-danger remove_fields" onclick="eliminar({{ orden.id }},{{ id }})">
                                                        <i class=" glyphicon glyphicon-trash icon-white"></i>
                                                      </a></td>
                        <td><select name="id_areas{{ forloop.counter }}" id="id_areas{{ forloop.counter }}"  class="form-control">
                                                         {% for am  in ambientes %}
                                                           <option value="{{ am.id }}"
                                                           {% if orden.areas_id == am.id %}
                                                           selected="selected"
                                                           {% endif %}
                                                           > {{ am.descripcion }}</option>
                                                        {% endfor %}
                                                     </select>
                                                     </td>
                        <td><input type="number" class="form-control" value="{{ orden.secuencia }}" id="secuencia_guardar{{ forloop.counter }}" name="secuencia_guardar{{ forloop.counter }}"/></td>
                        <td><textarea name="observaciones{{ forloop.counter }}"  id="observaciones{{ forloop.counter }}" cols="30" rows="5">
                          {{ orden.observaciones }}
                        </textarea></td>

                        <td><input type="checkbox" class="form-control" name="finalizada{{ forloop.counter }}"  id="finalizada{{ forloop.counter }}"
                        {% if orden.finalizada %}
                                                           checked="checked"
                                                           {% endif %}/></td>
<td>{% if orden.finalizada %}
                        Finalizada

                            {% else %}
                        En Proceso
                            {% endif %}
                        </td>

                        <td>

                        <!-- <a href="{% url 'subordenproduccion-manoobra' orden.id %}">
                        <button type="button" class="btn btn-info btn-xs"><i class="fa fa-cog"></i> Mano de Obra</button> </a>
                          <a href="{% url 'subordenproduccion-receta' orden.id %}">
                        <button type="button" class="btn btn-info btn-xs"><i class="fa fa-cog"></i> Materiales</button> </a> -->
                        <a  onclick="enviarBodegaCrudo({{id}},{{orden.id}})" >
                        <button type="button" class="btn btn-info btn-xs"><i class="fa fa-cog"></i> Enviar Bodega en Crudo</button> </a>
                          <a href="{% url 'subordenproduccion-imprimir' orden.id %}" >
                        <button type="button" class="btn btn-info btn-xs"><i class="fa fa-cog"></i> Imprimir</button> </a>
                      </td>

                      </tr >
                        {% else %}
                          {% endif %}
                    {% endfor %}

                  </tbody>
                </table>
              </div>




						<div class="col-md-10">
{% if op.finalizada %}
       <span style="color:blue;font-weight: bold">  *No puede realizar ninguna modificaci&oacute;n debido a que el producto ya fue ingresado a bodega</span>
         {% else %}
                                    <button type="submit" class="btn btn-primary btn-lg"><i class="fa fa-save"></i> Guardar</button>
         {% endif%}

</div>						<div class="col-md-4">
<!-- <a onclick="finalizar({{id}})" class="default btn btn-link" >
                                 <button type="button" class="btn btn-primary btn-lg">  Crear Producto</button></a>
 -->										</div>
<div class="col-md-4">
{% if op.finalizada  %}
{% else  %}
{% if finalizada == 1 %}
<a class="default btn btn-link boton_bodega" id="boton_bodega" onclick="enviarBodega({{id}})"><button type="button" class="btn btn-primary btn-lg">  Enviar Bodega</button></a>
{% endif %}
    {% endif %}
				</div>		</div>
					</div>
					{% if subordenes %}
<input type="hidden" name="columnas_receta" id="columnas_receta" value="{{ subordenes|length }}" />
{% else %}
<input type="hidden" name="columnas_receta" id="columnas_receta" value="1" />

{% endif %}
 </form>

					<!-- end panel -->

					<!-- #modal-dialog -->
					<div class="modal fade" id="modal-dialog">
						<div class="modal-dialog">
							<div class="modal-content">
							{% if form_mode == "update" %}
							<form method="post" action="{% url 'ordenescompra-update' ordenescompra.pk %}" data-parsley-validate="true" name="form-wizard" enctype="multipart/form-data">
							{% else %}
							<form method="post" action="{% url 'ordenescompra-create' %}" data-parsley-validate="true" name="form-wizard" enctype="multipart/form-data">
							{% endif %}
									{% csrf_token %}
									<div class="modal-header">
										<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
										<h4 class="modal-title">Nueva Orden de Compra</h4>
									</div>
									<div class="modal-body">
									</div>
									<div class="modal-footer">
										<a href="javascript:;" class="btn btn-sm btn-white" data-dismiss="modal">Close</a>
										<button type="submit" class="btn btn-sm btn-success">Guardar</button>
									</div>
								</form>

							</div>
						</div>
					</div>
				</div>
				<!-- end col-12 -->

{% endblock %}

{% block javascript %}
{{ block.super }}


	<script type="text/javascript">


	function detalledeCompra(id){
          $.ajax({
                url: "/config/obtenerDetalleCompra/", // the endpoint
                type : "POST", // http method
                data : { id : id,'csrfmiddlewaretoken': '{{ csrf_token }}'},
                success:function(data){
                  $("#detalle").append(data);
                },
                error: function(){

                },
              });
    }
      function agregar(id){
       var ambiente=$("#ambientes").val();
	   var secuencia=$("#secuencia").val();
     var reproceso="false";

     if( $('#reproceso').prop('checked') ) {
    reproceso="true";
}else{
	reproceso="false";
}
          $.ajax({
                url: "/subordenproduccion/agregarSubordenproduccion/", // the endpoint
                type : "POST", // http method
                data : { id : id,secuencia : secuencia,ambiente : ambiente,reproceso : reproceso,'csrfmiddlewaretoken': '{{ csrf_token }}'},
                success:function(data){
                  alert("Se  agrego satisfactoriamente")
                  window.location.href ="/subordenproduccion/subordenproduccion/"+id+"/list";
                },
                error: function(){

                },
              });
    }
    function eliminar(id,pk){

          $.ajax({
                url: "/subordenproduccion/eliminarSubordenproduccion/", // the endpoint
                type : "POST", // http method
                data : { id : id,'csrfmiddlewaretoken': '{{ csrf_token }}'},
                success:function(data){
                  alert("Se elimino el item satisfactoriamente");
                  window.location.href ="/subordenproduccion/subordenproduccion/"+pk+"/list";

                },
                error: function(){

                },
              });
    }

      function enviarBodega(id){

          $.ajax({
                url: "/subordenproduccion/subordenproduccion/enviarBodega/", // the endpoint
                type : "POST", // http method
                data : { id : id,'csrfmiddlewaretoken': '{{ csrf_token }}'},
                success:function(data){
                  alert("Se  envio a bodega satisfactoriamente");
                    $("#boton_bodega").css("display", "none");

                },
                error: function(){
                  alert("Verifique si ha terminado todas las etapas y si ha creado el producto")

                },
              });
    }
    function enviarBodegaCrudo(id,subopid){

          $.ajax({
                url: "/subordenproduccion/subordenproduccion/enviarBodegaCrudo/", // the endpoint
                type : "POST", // http method
                data : { id : id,subopid:subopid,'csrfmiddlewaretoken': '{{ csrf_token }}'},
                success:function(data){
                  alert("Se  envio a bodega de productos en crudo satisfactoriamente")
                },
                error: function(){
                  alert("Verifique si ha terminado todas las etapas y si ha creado el producto")

                },
              });
    }
     function finalizar(id){
      var num_recetas=$('#columnas_receta').val();
      var total=0;
      var cantidad=0;
      var i;
      //alert(' BNUM RECETS'+num_recetas);
      for (i = 1; i <= num_recetas; i++) {
      	if( $('#finalizada'+i).prop('checked') ) {
      			total++;
					}



      }

      if(total==num_recetas){
      	 window.location.href ="/inventario/producto/"+id+"/nuevo_orden_produccion";

      }else{
      	alert("Debe finalizar todas las etapas")
      }
    }
	</script>
	<!-- ================== END PAGE LEVEL JS ================== -->
	{% if form.errors or form_mode == "update" %}
	<script type="text/javascript">
		$( document ).ready(function() {
		    $(".modal").modal('toggle');
		});

	</script>
	{% endif %}
{% endblock %}
