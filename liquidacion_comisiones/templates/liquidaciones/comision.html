{% extends "login/base_nuevo.html" %}
{% load staticfiles %}

{# Load the tag library #}
{% load bootstrap3 %}

{# Load CSS and JavaScript #}
{% bootstrap_javascript %}

{# Display django.contrib.messages as Bootstrap alerts #}
{% bootstrap_messages %}

{% block css %}
{{ block.super }}
    <!-- ================== BEGIN PAGE LEVEL STYLE ================== -->
    <link href="{% static 'color_admin/assets/plugins/bootstrap-wizard/css/bwizard.min.css' %}" rel="stylesheet" />
        <link href="{% static 'color_admin/assets/plugins/bootstrap-datepicker/css/datepicker.css'%}" rel="stylesheet" />
  <link href="{% static 'color_admin/assets/plugins/bootstrap-datepicker/css/datepicker3.css'%}" rel="stylesheet" />
    <!-- ================== END PAGE LEVEL STYLE ================== -->
{% endblock %}

{% block section_title %}Comisiones y Adelantos{% endblock %}
{% block section_subtitle %}Por favor diligencie el siguiente formulario{% endblock %}
{% block content %}

            <!-- begin row -->
           <style>
       .panel-border{border: 1px solid #ddd !important}
       .form-ajust .form-group{margin-bottom: 0px !important}
      input[type="text"],select,input[type="number"]
      {

    border: 1px solid #ccd0d4;
    border-radius: 3px;
    box-shadow: none;
    font-size: 12px;
    display: block;
    width: 100%;
    height: 34px;
    padding: 6px 12px;
    line-height: 1.42857143;
    color: #555;
    background-color: #fff;
    background-image: none;
       }

 .table2 {
    width: 100%;
    max-width: 100%;
    margin-bottom: 20px;
      display:table}

.table2>tbody>tr>td, .table2>tbody>tr>th, .table2>tfoot>tr>td, .table2>tfoot>tr>th {
    border-color: #e2e7eb;
    padding: 1px 0px;
}

 .table2>thead>tr>td, .table2>thead>tr>th {
    border-color: #e2e7eb;
    padding: 10px 5px;
}
#id_abreviatura_codigo{
    width:50px;
  }
  #id_codigo{
    width:120px;
  }
    </style>
  <form method="post" data-parsley-validate="true" name="form-wizard" enctype="multipart/form-data"> {% csrf_token %}
   {{ form.title.errors }}
  <div class="row">
                <!-- begin col-6 -->
      <div class="col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading">

                        <h3 class="panel-title">Comision</h3>
                    </div>
                    <div class="panel-body">
                        <div class="col-md-12">
                            <div>

                                <!-- Nav tabs -->
                                <ul class="nav nav-tabs" role="tablist">
                                  <li role="presentation" class="active"><a href="#principales" aria-controls="principales" role="tab" data-toggle="tab">Principales</a></li>
<!--                                     <li role="presentation"><a href="#costo" aria-controls="costo" role="tab" data-toggle="tab">Costos y Precios</a></li>
 -->
                                  <li role="presentation"><a href="#foto" aria-controls="foto" role="tab" data-toggle="tab">Foto</a></li>
                                </ul>

                                <!-- Tab panes -->
                                <div class="tab-content">
                                    <div role="tabpanel" class="tab-pane fade in active" id="principales">
                           <div class="row">

                                            <div class="panel panel-default panel-border">
                                                <div class="panel-heading">Registro</div>
                                                <div class="panel-body">


                                            <table border="0" class="table2 " >
                                                 <tr>
                                                    <th colspan="7" style="text-align:center;">PROFORMA No. {{proforma.abreviatura_codigo }}-{{proforma.codigo }}-2016 <br /></th>
                                                </tr>
                                                <tr>
                                                    <th style="text-align:left">Cliente</th><td colspan="2"> {{proforma.cliente}} </td><td></td><th style="text-align:left">Fecha</th><td colspan="2"> {{proforma.fecha}} </td>
                                                </tr>
                                                <tr>
                                                    <th style="text-align:left">Direccion de entrega</th><td colspan="2"> {{proforma.direccion_entrega}} </td><td></td><th style="text-align:left">Raz√≥n Social</th><td colspan="2">  </td>
                                                </tr>

                                    <tr>
                                                    <th style="text-align:left">Referencia</th><td colspan="2"> {{proforma.vendedor}} </td><td></td><th ></th><td colspan="2">  </td>
                                                </tr>
                                                 <tr>
                                                    <th style="text-align:left">Referido por</th><td colspan="2">
                                                     {% if proforma.referido_por %}
                                                     {{proforma.referido_por}}
                                                 {% endif %}</td><td></td><th ></th><td colspan="2">  </td>
                                                </tr>


                                            </table>
                                            <br>


                            <table border="0" class="table2 table-striped table-bordered" >

                                <tr>
                                    <th>CANTIDAD</th><th colspan="2">DESCRIPCION</th><th colspan="2">DETALLE</th><th>Valor Unit</th><th>Total</th>
                                </tr>

                                 {% for a  in ambiente %}
                                 <tr >
                                    <td colspan="7"><b> {{ a.1 }}</b></td>
                                </tr>

                                             {% for r  in row %}
                                                 {% if a.0 == r.0 %}
                                                    <tr>

                                                        <td>{{ r.2 }}</td><td colspan="2">{{ r.1 }}</td><td colspan="2">{{ r.5 }}</td><td style="text-align:right">{{ r.3 }}</td><td style="text-align:right">{{ r.4 }}</td>
                                                    </tr>
                                                    {% endif %}
                                               {% endfor %}

                                 {% endfor %}
                                 <tr>

                                    <td colspan="5"></td><th style="text-align:left">Subtotal</th><td style="text-align:right">${{ proforma.subtotal }}</td>
                                                    </tr>
                            <tr>

                                    <td colspan="5"></td><th style="text-align:left">Descuento {{ proforma.porcentaje_descuento }}</th><td style="text-align:right">${{ proforma.descuento }}</td>
                                                    </tr>
                                <tr>

                                    <td colspan="5"></td><th style="text-align:left">IVA {{ proforma.porcentaje_iva }}%</th><td style="text-align:right">${{ proforma.iva }}</td>
                                                    </tr>
                                                    <tr>

                                    <td colspan="5"></td><th style="text-align:left">Total</th><td style="text-align:right">${{ proforma.total }}</td>
                                                    </tr>
                            </table>



                                        </div></div></div>


                                        <div class="row" style="">
                                            <div class="panel panel-default panel-border">
                                                <!-- Default panel contents -->
                                                <div class="panel-heading">Vendedores </div>
                                                <div class="panel-body">

                                                </div>

                                                <!-- Table -->
                                                <table class="table2 table-striped table-bordered"  id="tabla">
                                                <thead>
                                                  <tr>
                                                    <th></th>


                                                    <th >Vendedor</th>
                                                    <th >Porcentaje de Comision</th>
                                                    <th >Valor</th>

<th >Accion</th>
                                                  </tr>
                                                </thead>
                                                  <tbody>
                                                     {% if detalle %}
                                                    {% for kit  in detalle %}

                                                  <tr>
                                                    <td class="eliminar"><a class="btn btn-danger remove_fields">
                                                        <i class=" glyphicon glyphicon-trash icon-white"></i>
                                                      </a>
                                                    </td>

                                                    <td>
                                                    <input type="hidden" class="form-control" id="id_detalle{{ forloop.counter }}" name="id_detalle{{ forloop.counter }}" value="{{ kit.id }}"/>
                                                    <input type="hidden" class="form-control" id="id_kits{{ forloop.counter }}" name="id_kits{{ forloop.counter }}" value="{{ kit.vendedor_id }}"/>
                                                    <select name="vendedor_kits{{ forloop.counter }}" id="vendedor_kits{{ forloop.counter }}">
                                                         {% for am  in vendedor %}
                                                           <option value="{{ am.id }}"
                                                           {% if kit.vendedor_id == am.id %}
                                                           selected="selected"
                                                           {% endif %}
                                                           > {{ am.nombre }}</option>
                                                        {% endfor %}
                                                     </select>
                                                    </td>
                                                      <td><input type="text" class="form-control" id="porcentaje_kits{{ forloop.counter }}" name="porcentaje_kits{{ forloop.counter }}" value="{{ kit.porcentaje_comision }}" onkeyup="actualizarCosto({{ forloop.counter }})"></td>
                                             <td><input type="text" class="form-control" id="valor_kits{{ forloop.counter }}" name="valor_kits{{ forloop.counter }}" value="{{ kit.valor }}"></td>
                                                      <td> <a href="{% url 'liquidaciones-adelanto-comision-vendedor' kit.id %}">
														<button type="button" class="btn btn-info btn-xs"><i class="fa fa-copy"></i> Adelanto de Comision</button>
													</a></td>
                                                  </tr>
                                                        {% endfor %}
                                                   {% else %}
                                                     <tr>
                                                    <td class="eliminar"><a class="btn btn-danger remove_fields">
                                                        <i class=" glyphicon glyphicon-trash icon-white"></i>
                                                      </a>
                                                    </td>

                                                    <td>
                                                    <input type="hidden" class="form-control" id="id_kits1" name="id_kits1"/>
<select name="vendedor_kits1" id="vendedor_kits1">
                                                         {% for am  in vendedor %}
                                                           <option value="{{ am.id }}"> {{ am.nombre }}</option>
                                                        {% endfor %}
                                                     </select>
                                                    </td>
                                                          <td><input  type="text" class="form-control" id="porcentaje_kits1" name="porcentaje_kits1" onkeyup="actualizarCosto(1)"></td>
                                                    <td><input  type="text" class="form-control" id="valor_kits1" name="valor_kits1"></td>
                                                  </tr>


                                                   {% endif %}

                                                   </tbody>
                                                  <tfoot>


                                                  </tfoot>
                                                </table>
                                            </div>
                                        </div>

                                        <p class="text-center">
                                             <button type="button" class="btn btn-primary btn-lg" id="add">Agregar</button>


                                        </p>





                                    </div>



                                </div>

                            </div>
                        </div>


                                        </div>
                    </div>
                </div>
            </div>
        </div>

     <p class="text-center">

                                    <button type="submit" class="btn btn-primary btn-lg"><i class="fa fa-cog"></i> Guardar</button>
                                            <a class="default btn btn-link" href="/liquidacion_comisiones/proformaComision/"><button type="button" class="btn btn-primary btn-lg">  Regresar</button></a>
                                        </p>
                                         {% if detalle %}
<input type="hidden" name="columnas_receta" id="columnas_receta" value="{{ detalle|length }}" />
{% else %}
<input type="hidden" name="columnas_receta" id="columnas_receta" value="1" />

{% endif %}
<input type="hidden" name="total" id="total" value="{{ proforma.total }}" />
      <input type="hidden" name="subtotal" id="subtotal" value="{{ proforma.subtotal }}" />

<input type="hidden" name="tipo_vendedor" id="tipo_vendedor" value="
 {% if proforma.vendedor.externo %}
 {{ proforma.vendedor.externo }}
  {% else %}
  0
 {% endif %}" />
      <input type="hidden" name="referido" id="referido" value=" {% if proforma.referido_por %}
 {{ proforma.referido_por }}
  {% else %}
  0
 {% endif %}" />

    <input type="hidden" name="id_fila_cambiar" id="id_fila_cambiar" value="" />
<input type="hidden" name="vendedor_id" id="vendedor_id" value="{{ proforma.vendedor.id }}" />

<input type="hidden" name="comision" id="comision" value="{{ comision.valor }}" />
      <input type="hidden" name="comision_10000" id="comision_10000" value="{{ comision_10000.valor }}" />
      <input type="hidden" name="comision_6000" id="comision_6000" value="{{ comision_6000.valor }}" />
      <input type="hidden" name="comision_externo" id="comision_externo" value="{{ comision_externo.valor }}" />
      <input type="hidden" name="comision_referida" id="comision_referida" value="{{ comision_referida.valor }}" />

  </form>
                               <div class="modal fade bs-example-modal-sm" id="modal-dialog">
                        <div class="modal-dialog">
                            <div class="modal-content">
                             <div class="panel-body">
                                <div class="table-responsive">
                                                     <table class="table table-striped table-bordered" id="tabla2">
                                                        <thead>
                                                            <tr>
                                                            <th></th>
                                                                <th>Codigo</th>
                                                                <th>Nombre</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                        {% for r  in empleados %}
                                                            <tr>
                                                                <td  onclick="cargarCodigoProducto('{{ r.empleado_id }}','{{ r.codigo_empleado }}','{{ r.nombre_empleado }}')"><a class="btn btn-danger remove_fields">
                                                        <i class=" glyphicon glyphicon-plus icon-white"></i>
                                                      </a></td><td>{{ r.cedula_empleado }}</td>
                                                                <td>{{ r.nombre_empleado }}</td>

                                                            </tr >
                                                        {% endfor %}

                                                        </tbody>
                                                    </table>
                                                </div>
                                                <button type="button" onclick="cerrar()" class="btn btn-danger btn-block">Cerrar <i class=" glyphicon glyphicon-trash icon-white"></i></button>


                            </div>
                        </div>
                    </div>
                    </div>



{% endblock %}

{% block javascript %}
{{ block.super }}
<script src="{% static 'color_admin/assets/plugins/parsley/dist/parsley.js' %}"></script>
<script src="{% static 'color_admin/assets/plugins/bootstrap-wizard/js/bwizard.js' %}"></script>
<script src="{% static 'color_admin/assets/js/form-wizards-validation.demo.min.js' %}"></script>
<script src="{% static 'color_admin/assets/js/apps.min.js' %}"></script>
<script src="{% static 'color_admin/assets/plugins/DataTables-1.9.4/js/jquery.dataTables.js' %}"></script>
<script src="{% static 'color_admin/assets/plugins/DataTables-1.9.4/js/data-table.js' %}"></script>

<script>
  $(document).ready(function() {
    // App.init();
    $('#tabla2').DataTable();
    $('#tabla3').DataTable();

    FormWizardValidation.init();
    $(".parsley-errors-list").css('display','none');
$('#id_fecha_nacimiento').datepicker({todayHighlight:true,autoclose:true});
      $('#id_fechapedido').datepicker({todayHighlight:true,autoclose:true});
      cambiarFormato();
  });


      function actualizarCosto(data){
      var cantidad=$('#porcentaje_kits'+data).val();
      var costo= $('#subtotal').val();
          var cantidad_final=0;
          var externo= $('#tipo_vendedor').val();
          var referido= $('#referido').val();
       var valor=0;
          var comision_10000= $('#comision_10000').val();
          var comision_6000= $('#comision_6000').val();
          var comision_referida= $('#comision_referida').val();
          var comision_externo= $('#comision_externo').val();
          var comision= $('#comision').val();
           var vendedor_id= $('#vendedor_kits'+data).val();
          if(vendedor_id!=2) {

              if(externo!=0 || referido!=0){
                  if (externo!=0){

                  }

                   if (referido!=''){
                       if (cantidad > comision_referida) {
                            alert("Es una proforma realizada a atraves de un intermediario solo puede recibir hasta " + comision_referida + "% de comision");
                       $('#porcentaje_kits' + data).val(comision_referida);
                  }}


              }else{
                              if (costo > 10000) {
                              if (cantidad > comision_10000) {
                                  alert("La cantidad supera los 10000 solo puede recibir hasta el " + comision_10000 + "% de comision");
                                  $('#porcentaje_kits' + data).val(comision_10000);

                              }

                          } else {
                                          if (costo > 6000) {
                                              if (cantidad > comision_6000) {
                                                  alert("La cantidad supera los 6000 solo puede recibir hasta el " + comision_6000 + "% de comision");
                                                  $('#porcentaje_kits' + data).val(comision_6000);
                                              }

                                              alert('entro1');
                                          } else {
                                              if (cantidad > comision) {
                                                  alert("Solo puede recibir hasta el " + comision + "% de comision");
                                                  $('#porcentaje_kits' + data).val(comision);
                                              }

                                          }

                                    }
              };

          }else{

          }

      //  alert(data);
      // alert(costo);
      // alert(valor);
              cantidad_final=$('#porcentaje_kits'+data).val();


          valor=parseFloat(parseFloat(cantidad_final)*parseFloat(costo)/100).toFixed(2);
      $('#valor_kits'+data).val(valor);
    }

</script>
<script>




    $(document).ready(function() {
      $('#id_codigo').each(function(){
  $(this).attr('readonly','readonly');
});
       $('#id_abreviatura_codigo').each(function(){
  $(this).attr('readonly','readonly');
});
             $('#id_created_by').each(function(){
  $(this).attr('readonly','readonly');
});
        $('#id_updated_by').each(function(){
  $(this).attr('readonly','readonly');
});
        $('#id_created_at').each(function(){
  $(this).attr('readonly','readonly');
});
        $('#id_updated_at').each(function(){
  $(this).attr('readonly','readonly');
});





   });

</script>
<script>

    function mostrarProductos(data){
       $('#id_fila_cambiar').val(data);
       $(".bs-example-modal-sm").modal('toggle');
    }
    function cerrar(){
       $(".bs-example-modal-sm").modal('toggle');
    }


    function cargarCodigoProducto(id,codigo,descripcion){
      var fila=$('#id_fila_cambiar').val();
         $('#id_kits'+fila).val(id);


        $('#codigo_kits'+fila).val(codigo);
         $('#nombre_kits'+fila).val(descripcion);
          // $('#medida_kits'+fila).val(medida);

          cerrar();

    }


</script>
<script type="text/javascript">
    $(document).ready(function(){
        /**
         * Funcion para  una nueva columna en la tabla
         */
        $("#add").click(function(){
            // Obtenemos el numero de filas (td) que tiene la primera columna
            // (tr) del id "tabla"
            var num_recetas=$('#columnas_receta').val();
            num_recetas=parseInt(num_recetas)+1;

            var tds=$("#tabla tr:first td").length;
            // Obtenemos el total de columnas (tr) del id "tabla"
            var trs=$("#tabla tr").length;
           var nuevaFila='<tr><td  class="eliminar"><a class="btn btn-danger remove_fields "><i class=" glyphicon glyphicon-trash icon-white"></i></a></td>';
          nuevaFila+='<td><input type="hidden" class="form-control" id="id_kits'+num_recetas+'" name="id_kits'+num_recetas+'"> ';

                    nuevaFila+='<select class="form-control" id="vendedor_kits'+num_recetas+'" name="vendedor_kits'+num_recetas+'" > ';
                                    {% for am  in vendedor %}
                      nuevaFila+='<option value="{{ am.id }}"> {{ am.nombre }}</option>';

                                  {% endfor %}
              nuevaFila+='</select></td>';
               nuevaFila+='<td><input type="text" class="form-control" required="required" id="porcentaje_kits'+num_recetas+'" name="porcentaje_kits'+num_recetas+'" onkeyup="actualizarCosto('+num_recetas+')"></td>';
              nuevaFila+='<td><input type="text" class="form-control" required="required" id="valor_kits'+num_recetas+'" name="valor_kits'+num_recetas+'"></td>';


                nuevaFila+='</tr>';

              $('#columnas_receta').val(num_recetas);
            // for(var i=0;i<tds;i++){
            //     //  las columnas
            //     nuevaFila+="<td>columna "+(i+1)+"  con jquery</td>";
            // }
            // //  una columna con el numero total de columnas.
            // // uno al total, ya que cuando cargamos los valores para la
            // // columna, todavia no esta
            // nuevaFila+="<td>"+(trs+1)+" columnas";
            // nuevaFila+="</tr>";
            $("#tabla").append(nuevaFila);
        });

        /**
         * Funcion para eliminar la ultima columna de la tabla.
         * Si unicamente queda una columna, esta no sera eliminada
         */
        $("#del").click(function(){
            // Obtenemos el total de columnas (tr) del id "tabla"
            var trs=$("#tabla tr").length;
            if(trs>1)
            {
                // Eliminamos la ultima columna
                $("#tabla tr:last").remove();
            }
        });


        $(document).on("click",".eliminar",function(){
            var parent = $(this).parent();
  $(parent).remove();
          });

    });
     function cambiarFormato(){
      var num_recetas=$('#columnas_receta').val();
      //alert(num_recetas);
      var total=0;
      var costo1=0;
      var subt=0;
      var porc_descu=0;
      var iva=0;
      var r_total=0;
      var r_subtotal=0;
      var total=0;
var porcentaje_iva=0;
      var i;
      //alert(' BNUM RECETS'+num_recetas)



      for (i = 1; i <= num_recetas; i++) {
        costo1= $('#valor_kits'+i).val();

        costo1 = costo1.toString().replace(/\,/g,'.');
        $('#valor_kits'+i).val(costo1);

           porcentaje_iva= $('#porcentaje_kits'+i).val();

        porcentaje_iva = porcentaje_iva.toString().replace(/\,/g,'.');
        $('#porcentaje_kits'+i).val(porcentaje_iva);

      }
      }
    </script>
{% endblock %}